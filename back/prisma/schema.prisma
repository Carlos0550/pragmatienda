generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum PlanType {
  FREE
  STARTER
  PRO
}


enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  DELETED
  BLOCKED
}

enum ProductsStatus {
  PUBLISHED
  UNPUBLISHED
  DELETED
  ARCHIVED
  LOW_STOCK
  OUT_OF_STOCK
}

enum OrderStatus {
  PENDING
  PROCESSED
  CANCELLED
  REFUNDED
  SHIPPED
  DELIVERED
  COMPLETED
  FAILED
  REFUND_REQUESTED
  REFUND_APPROVED
  REFUND_REJECTED
  REFUND_COMPLETED
  REFUND_FAILED
}

enum PaymentStatus {
  PENDING
  REQUIRES_ACTION
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELED
  EXPIRED
}

enum FulfillmentStatus {
  UNFULFILLED
  PREPARING
  SHIPPED
  DELIVERED
  RETURNED
  CANCELED
}

model Tenant {
  id           String     @id @default(cuid())
  ownerId      String
  owner        User       @relation("TenantOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  plan         PlanType   @default(FREE)
  planStartsAt DateTime   @default(now())
  planEndsAt   DateTime?
  trialEndsAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  users              User[]            @relation("TenantUsers")
  productsCategories ProductsCategory[] @relation("TenantProductsCategory")
  businessData       BusinessData?     @relation("TenantBusiness")
  products           Products[]        @relation("TenantProducts")
  cart               Cart[]            @relation("TenantCart")
  order              Order[]           @relation("TenantOrder")
  paymentEvents      PaymentEvent[]    @relation("TenantPaymentEvents")
  idempotencyKeys    IdempotencyKey[]  @relation("TenantIdempotencyKeys")
}


model BusinessData {
  id        String   @id @default(cuid())
  name      String
  description String?
  address String?
  phone String?
  email String?
  website String?
  logo String?
  favicon String?
  banner String?
  socialMedia Json?
  tenantId  String   @unique
  tenant    Tenant   @relation("TenantBusiness", fields: [tenantId], references: [id], onDelete: Cascade)

  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  @@index([name])
  @@unique([name])
  @@unique([phone])
  @@unique([email])
}


model User {
  id        String   @id @default(cuid())
  email     String   
  phone     String?   
  name      String?
  password  String
  role      Int      @default(1)
  avatar    String?
  isVerified Boolean  @default(false)
  status     UserStatus @default(ACTIVE)
  tenantId  String?
  tenant    Tenant? @relation("TenantUsers", fields: [tenantId], references: [id], onDelete: Cascade)
  ownedTenants Tenant[] @relation("TenantOwner")
  cart Cart[] @relation("UserCart")
  order Order[] @relation("UserOrder")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([email, tenantId, role])
}



model ProductsCategory {
  id        String   @id @default(cuid())
  name      String
  description String?
  image String?
  tenantId String
  tenant Tenant @relation("TenantProductsCategory", fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Products[] @relation("ProductsCategory")

  @@index([name])
  @@unique([tenantId, name])
}

model Products {
  id        String   @id @default(cuid())
  name      String
  description String?
  image String?
  metadata Json?
  price Decimal
  stock Int
  status ProductsStatus @default(PUBLISHED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenantId String
  categoryId String?
  orderItem OrderItem[] @relation("ProductOrderItems")
  tenant Tenant @relation("TenantProducts", fields: [tenantId], references: [id], onDelete: Cascade)
  category ProductsCategory? @relation("ProductsCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  cart CartItem[] @relation("ProductCartItems")
  @@index([name])
  @@unique([tenantId, name])
}

model Cart{
  id String @id @default(cuid())
  tenantId String
  userId String
  items CartItem[] @relation("CartItems")
  user User @relation("UserCart", fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation("TenantCart", fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@unique([tenantId, userId])
}

model CartItem{
  id String @id @default(cuid())
  cartId String
  cart Cart @relation("CartItems", fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product Products @relation("ProductCartItems", fields: [productId], references: [id], onDelete: Cascade)
  quantity Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cartId])
  @@index([productId])
  @@unique([cartId, productId])
}

model Order{
  id String @id @default(cuid())
  tenantId String
  userId String
  paymentProofImage String
  status OrderStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  subtotal Decimal @default(0)
  shippingCost Decimal @default(0)
  tax Decimal @default(0)
  discount Decimal @default(0)
  total Decimal @default(0)
  currency String @default("ARS")
  paymentProvider String?
  paymentReference String?
  paymentMethod String?
  shippingProvider String?
  shippingService String?
  trackingCode String?
  shippingAddress Json?
  billingAddress Json?
  customerNote String?
  paidAt DateTime?
  shippedAt DateTime?
  deliveredAt DateTime?
  items OrderItem[] @relation("OrderItems")
  user User @relation("UserOrder", fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation("TenantOrder", fields: [tenantId], references: [id], onDelete: Cascade)
  paymentEvents PaymentEvent[] @relation("OrderPaymentEvents")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([paymentProvider])
  @@index([trackingCode])
}

model OrderItem{
  id String @id @default(cuid())
  orderId String
  order Order @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product Products @relation("ProductOrderItems", fields: [productId], references: [id], onDelete: Cascade)
  quantity Int
  unitPrice Decimal @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@unique([orderId, productId])
}

model PaymentEvent {
  id String @id @default(cuid())
  tenantId String
  orderId String?
  provider String
  eventId String
  eventType String
  payload Json
  processedAt DateTime @default(now())
  createdAt DateTime @default(now())

  tenant Tenant @relation("TenantPaymentEvents", fields: [tenantId], references: [id], onDelete: Cascade)
  order Order? @relation("OrderPaymentEvents", fields: [orderId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([orderId])
  @@index([provider])
  @@index([eventType])
  @@unique([provider, eventId])
}

model IdempotencyKey {
  id String @id @default(cuid())
  tenantId String
  scope String
  key String
  requestHash String
  responseStatus Int?
  responseBody Json?
  createdAt DateTime @default(now())
  expiresAt DateTime

  tenant Tenant @relation("TenantIdempotencyKeys", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([expiresAt])
  @@unique([tenantId, scope, key])
}
